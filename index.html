<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Commande Fruits & Légumes — UTILE ENTRAIGUES</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#f6f7f9;
    --card:#ffffff;
    --muted:#6b7280;
    --border:#e5e7eb;
    --green:#16a34a;
    --green-600:#16a34a;
    --green-700:#15803d;
    --black:#111827;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;padding:20px}
  .container{max-width:1200px;margin:auto}
  .nav{display:flex;gap:10px;margin-bottom:16px}
  .tab{padding:10px 14px;border:1px solid var(--border);background:var(--card);cursor:pointer;border-radius:8px;font-weight:600}
  .tab.active{background:var(--black);color:#fff;border-color:var(--black)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
  .muted{color:var(--muted);font-size:12px}
  .msg{padding:10px;border-radius:10px;border:1px solid #fde68a;background:#fef9c3;color:#854d0e}
  .footer{margin-top:20px;color:var(--muted);font-size:12px;text-align:center}
  input[type="number"], input[type="text"], select{
    padding:8px 10px;border:1px solid var(--border);border-radius:10px;min-width:70px;background:#fff
  }
  .btn{
    appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer
  }
  .btn-green{background:var(--green-600);color:#fff}
  .btn-green:hover{background:var(--green-700)}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
  .pill{background:#e8f5eb;color:#166534;border:1px solid #bbf7d0;padding:6px 10px;border-radius:999px;font-size:12px}
  .section-title{margin:0 0 8px 0}
  .sep{height:1px;background:var(--border);margin:12px 0}
</style>
<!-- XLSX pour lire .xlsx côté client -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">

  <!-- Onglets -->
  <div class="nav">
    <button class="tab active" id="tabCatalog" onclick="go('catalog')">Catalogue</button>
    <button class="tab" id="tabCart" onclick="go('cart')">Panier</button>
  </div>

  <!-- Page Catalogue -->
  <section id="pageCatalog">
    <div class="card">
      <h3 class="section-title">Importer le cadencier</h3>
      <div class="row">
        <input type="file" id="file" accept=".csv,.xlsx,.xls"/>
        <button class="btn btn-green" onclick="triggerFile()">Choisir un fichier</button>
        <span id="status" class="msg" style="display:none"></span>
      </div>

      <div class="sep"></div>

      <h3 class="section-title">Filtres</h3>
      <div class="toolbar">
        <select id="famFilter" onchange="applyFilters()">
          <option value="">Toutes les familles</option>
        </select>
        <input id="qSearch" type="text" placeholder="Rechercher un produit..." oninput="applyFilters()"/>
        <span class="pill" id="countInfo">0 produit</span>
        <span class="muted" id="fileInfo"></span>
      </div>
    </div>

    <div id="grid" class="grid" style="margin-top:12px"></div>
  </section>

  <!-- Page Panier -->
  <section id="pageCart" style="display:none">
    <div class="card">
      <h3 class="section-title">Panier</h3>
      <div id="cart"></div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn btn-green" onclick="exportCartCSV()">Exporter le panier (CSV)</button>
        <button class="btn" onclick="clearCart()">Vider le panier</button>
      </div>
    </div>
  </section>

  <div class="footer">UTILE ENTRAIGUES — Application de commande Fruits & Légumes</div>
</div>

<script>
/* --------------------- État & Persistance --------------------- */
const LS_ROWS_KEY = "ue_rows_v2";      // produits persistés
const LS_FILE_NAME = "ue_rows_file";   // nom fichier affichage
const LS_CART_KEY = "ue_cart_v1";      // panier persisté

let rows = [];        // [{id,famille,designation}]
let filtered = [];    // résultat des filtres
let cart = [];        // panier

/* --------------------- Navigation --------------------- */
function go(page){
  const cat = document.getElementById("pageCatalog");
  const crt = document.getElementById("pageCart");
  const tCat= document.getElementById("tabCatalog");
  const tCrt= document.getElementById("tabCart");
  const isCat = page==="catalog";
  cat.style.display = isCat ? "" : "none";
  crt.style.display = isCat ? "none" : "";
  tCat.classList.toggle("active", isCat);
  tCrt.classList.toggle("active", !isCat);
  if(!isCat) drawCart();
}

/* --------------------- UI Helpers --------------------- */
function triggerFile(){ document.getElementById("file").click(); }
function showMsg(txt){ const s=document.getElementById("status"); s.textContent=txt; s.style.display='inline-block'; }
function hideMsg(){ const s=document.getElementById("status"); s.style.display='none'; }
function norm(s){ return String(s||"").trim().toLowerCase(); }
function setFileInfo(name){ document.getElementById("fileInfo").textContent = name ? `Fichier chargé : ${name}` : ""; }
function updateCount(){
  const n = filtered.length;
  document.getElementById("countInfo").textContent = (n||0) + (n>1?" produits":" produit");
}

/* --------------------- Détection des en-têtes --------------------- */
function findHeaderRow(matrix){
  // Cherche ligne d'en-tête parmi les 10 premières
  const KEYS = ["famille","groupe","désignation","designation","libellé","libelle","produit"];
  const maxScan = Math.min(10, matrix.length);
  for(let r=0; r<maxScan; r++){
    const row = matrix[r]||[];
    const lower = row.map(norm);
    let hits = 0;
    for(const k of KEYS){ if(lower.some(c => c.includes(k))) hits++; }
    if(hits >= 2) return r;
  }
  return 0; // fallback
}

function headerMap(h){
  const s = norm(h);
  if(s.includes("famille") || s.includes("groupe")) return "famille";
  if(s.includes("désignation") || s.includes("designation") || s.includes("libell") || s.includes("produit")) return "designation";
  return null;
}

/* --------------------- Parsing fichier --------------------- */
function parseMatrix(matrix){
  if(!matrix.length){ rows=[]; return; }
  const headerRow = findHeaderRow(matrix);
  const headers = (matrix[headerRow]||[]).map(h=>h==null?"":String(h));
  const keys = headers.map(headerMap);
  const idxFam = keys.indexOf("famille");
  const idxDes = keys.indexOf("designation");

  const out = [];
  for(let r = headerRow+1; r < matrix.length; r++){
    const row = matrix[r]||[];
    const fam = idxFam>=0 && row[idxFam]!=null ? String(row[idxFam]).trim() : "";
    const des = idxDes>=0 && row[idxDes]!=null ? String(row[idxDes]).trim() : "";
    if(!des) continue;               // ignore lignes sans désignation
    out.push({ id:String(r), famille:fam, designation:des });
  }
  // tri par famille puis désignation
  out.sort((a,b)=> (a.famille||"").localeCompare(b.famille||"") || a.designation.localeCompare(b.designation));
  rows = out;
}

function handleCSV(text){
  // Détecte ; ou ,
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
  const sep = (lines[0] && lines[0].split(";").length>1) ? ";" : ",";
  const matrix = lines.map(l => l.split(sep));
  parseMatrix(matrix);
}

function handleXLSX(arrayBuffer){
  const wb = XLSX.read(new Uint8Array(arrayBuffer), {type:"array"});
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];
  const matrix = XLSX.utils.sheet_to_json(ws, {header:1, raw:true});
  parseMatrix(matrix);
}

function onFile(e){
  hideMsg();
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const ext = (f.name.split(".").pop()||"").toLowerCase();
  const reader = new FileReader();
  reader.onerror = () => showMsg("Lecture du fichier impossible. Réessaie ou enregistre au format CSV/XLSX.");
  if(ext==="csv"){
    reader.onload = ev => { handleCSV(ev.target.result); afterImport(f.name); };
    reader.readAsText(f, "utf-8");
  } else {
    reader.onload = ev => { handleXLSX(ev.target.result); afterImport(f.name); };
    reader.readAsArrayBuffer(f);
  }
}

function afterImport(fileName){
  if(!rows.length){
    showMsg("Aucun produit détecté. Vérifie que tes colonnes contiennent bien ‘Désignation’ et ‘Groupe/Famille’."); 
  } else {
    hideMsg();
    // Persistance
    localStorage.setItem(LS_ROWS_KEY, JSON.stringify(rows));
    localStorage.setItem(LS_FILE_NAME, fileName||"");
    setFileInfo(fileName);
  }
  rebuildFilters();
  applyFilters();
}

/* --------------------- Filtres & rendu --------------------- */
function rebuildFilters(){
  const famSel = document.getElementById("famFilter");
  // Construit la liste des familles à partir des rows
  const set = new Set(rows.map(r => (r.famille||"").trim()).filter(Boolean));
  const all = Array.from(set).sort((a,b)=>a.localeCompare(b));
  const current = famSel.value;
  famSel.innerHTML = `<option value="">Toutes les familles</option>` + 
    all.map(f=>`<option value="${escapeHtml(f)}"${f===current?' selected':''}>${escapeHtml(f)}</option>`).join("");
}

function applyFilters(){
  const fam = document.getElementById("famFilter").value;
  const q = norm(document.getElementById("qSearch").value);
  filtered = rows.filter(r=>{
    if(fam && (r.famille||"")!==fam) return false;
    if(q){
      const blob = norm(r.famille)+" "+norm(r.designation);
      if(!blob.includes(q)) return false;
    }
    return true;
  });
  draw();
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function draw(){
  const g = document.getElementById("grid");
  updateCount();
  if(!rows.length){
    g.innerHTML = `<div class="msg">Importe un fichier CSV/XLSX avec deux colonnes au minimum : <b>Désignation</b> et <b>Groupe/Famille</b>.</div>`;
    return;
  }
  if(!filtered.length){
    g.innerHTML = `<div class="msg">Aucun résultat avec les filtres actuels.</div>`;
    return;
  }
  g.innerHTML = filtered.map(r => `
    <div class="card">
      <div class="muted" style="margin-bottom:6px;">${escapeHtml(r.famille||"Sans famille")}</div>
      <div style="font-weight:700;margin-bottom:6px">${escapeHtml(r.designation)}</div>
      <div class="row">
        <input type="number" id="q_${r.id}" placeholder="Qté" min="0" step="1" style="width:100px">
        <select id="u_${r.id}">
          <option>colis</option>
          <option>kilo</option>
          <option>pièce</option>
        </select>
        <button class="btn btn-green" onclick='add("${r.id}")'>Ajouter</button>
      </div>
    </div>
  `).join("");
}

/* --------------------- Panier --------------------- */
function add(id){
  const qEl = document.getElementById("q_"+id);
  const uEl = document.getElementById("u_"+id);
  const q = Number(qEl && qEl.value);
  const u = uEl ? uEl.value : "colis";
  if(!q){ return; }
  const r = rows.find(x=>x.id===id);
  if(!r) return;
  cart.push({ ...r, quantite:q, unite:u });
  persistCart();
  // petit feedback
  qEl.value = "";
}

function drawCart(){
  const c = document.getElementById("cart");
  if(!c) return;
  if(!cart.length){ c.innerHTML = `<div class="msg">Panier vide</div>`; return; }
  c.innerHTML = cart.map((it,idx)=>`
    <div class="row" style="justify-content:space-between;align-items:flex-start;margin:6px 0;">
      <div>
        <div class="muted">${escapeHtml(it.famille||"Sans famille")}</div>
        <div style="font-weight:700">${escapeHtml(it.designation)}</div>
        <div>${it.quantite} ${escapeHtml(it.unite)}</div>
      </div>
      <button class="btn" onclick="removeFromCart(${idx})">Supprimer</button>
    </div>
  `).join("");
}

function removeFromCart(i){
  cart.splice(i,1);
  persistCart();
  drawCart();
}

function clearCart(){
  cart = [];
  persistCart();
  drawCart();
}

function persistCart(){
  localStorage.setItem(LS_CART_KEY, JSON.stringify(cart));
}

/* --------------------- Export Panier CSV --------------------- */
function exportCartCSV(){
  if(!cart.length) return;
  const header = ["Famille","Désignation","Quantité","Unité"].join(";");
  const lines = cart.map(it => [
    (it.famille||"").replace(/;/g,","), 
    (it.designation||"").replace(/;/g,","), 
    it.quantite, 
    it.unite
  ].join(";"));
  const csv = [header, ...lines].join("\r\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "commande.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

/* --------------------- Démarrage : restaurer données --------------------- */
function restorePersisted(){
  try{
    const saved = localStorage.getItem(LS_ROWS_KEY);
    const fname = localStorage.getItem(LS_FILE_NAME);
    if(saved){
      rows = JSON.parse(saved) || [];
      setFileInfo(fname || "");
      rebuildFilters();
      applyFilters();
    }
  }catch(e){}
  try{
    const c = localStorage.getItem(LS_CART_KEY);
    if(c){ cart = JSON.parse(c)||[]; }
  }catch(e){}
}

document.getElementById("file").addEventListener("change", onFile);
restorePersisted();
applyFilters(); // au cas où
</script>
</body>
</html>
