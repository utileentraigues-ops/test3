<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Commande Fruits & Légumes — UTILE ENTRAIGUES</title>
<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --ink:#111; --muted:#667085; --accent:#0ea5e9; --line:#e5e7eb; --warn:#f59e0b;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
  .container{max-width:1200px;margin:auto;padding:24px}
  .nav{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
  .tab{padding:10px 14px;border:1px solid var(--line);background:var(--card);cursor:pointer;border-radius:10px}
  .tab.active{background:var(--ink);color:#fff;border-color:var(--ink)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:12px}
  input[type="number"], select, input[type="text"]{padding:8px;border:1px solid var(--line);border-radius:10px}
  input[type="file"]{border:1px dashed var(--line);padding:10px;border-radius:10px;background:#fff}
  button{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .msg{padding:10px;border-radius:10px;border:1px solid #fde68a;background:#fffbeb;color:#8a5b00}
  .footer{margin-top:24px;text-align:center;color:var(--muted);font-size:12px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fafafa;color:#444;font-size:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
  .sticky{position:sticky;top:0;background:var(--card)}
  .kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .kpi{background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px;min-width:160px}
  .hidden{display:none}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
  <div class="nav">
    <button class="tab active" id="tabCatalog" onclick="go('catalog')">Catalogue</button>
    <button class="tab" id="tabCart" onclick="go('cart')">Panier</button>
    <button class="tab" id="tabHelp" onclick="go('help')">Aide</button>
  </div>

  <!-- CATALOGUE -->
  <section id="pageCatalog">
    <div class="card">
      <div class="row">
        <input type="file" id="file" accept=".csv,.xlsx,.xls" />
        <span id="status" class="msg hidden"></span>
      </div>
      <div class="row" style="margin-top:10px">
        <span class="pill">Entêtes attendues par défaut : <b>Famille</b>, <b>Designation</b>, <b>Prix</b></span>
        <button id="btnShowMapper" onclick="toggleMapper()" title="Mapper manuellement quand les entêtes diffèrent">Mapper les colonnes</button>
      </div>
      <div id="mapper" class="card hidden" style="margin-top:10px">
        <div class="row">
          <div>
            <label>Colonne Famille</label><br/>
            <select id="selFamille"></select>
          </div>
          <div>
            <label>Colonne Désignation</label><br/>
            <select id="selDesignation"></select>
          </div>
          <div>
            <label>Colonne Prix</label><br/>
            <select id="selPrix"></select>
          </div>
          <div style="align-self:end">
            <button class="primary" onclick="applyMapping()">Appliquer le mapping</button>
          </div>
        </div>
        <div id="headersPreview" style="margin-top:8px;color:#555"></div>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi"><b id="kpiItems">0</b><br/><small>produits détectés</small></div>
      <div class="kpi"><b id="kpiFamilies">0</b><br/><small>familles</small></div>
    </div>

    <div id="grid" class="grid"></div>
  </section>

  <!-- PANIER -->
  <section id="pageCart" class="hidden">
    <div class="card sticky">
      <div class="row">
        <button onclick="exportCartCSV()">Exporter le panier (CSV)</button>
        <button onclick="sendEmail()" class="primary">Envoyer par email</button>
        <input type="text" id="mailto" placeholder="email fournisseur (ex: commande@fournisseur.com)" style="min-width:280px"/>
      </div>
    </div>
    <div class="card" style="margin-top:12px">
      <table id="cartTable">
        <thead><tr><th>Famille</th><th>Produit</th><th>Qté</th><th>Unité</th><th></th></tr></thead>
        <tbody id="cartBody"></tbody>
      </table>
    </div>
  </section>

  <!-- AIDE -->
  <section id="pageHelp" class="hidden">
    <div class="card">
      <h3>Guide d’import</h3>
      <ol>
        <li>Prépare un fichier <b>CSV</b> ou <b>Excel</b> avec au moins les colonnes : <b>Famille</b>, <b>Designation</b>, <b>Prix</b>.</li>
        <li>Si les intitulés diffèrent (ex: “Famille produit”, “Libellé”, “Tarif TTC”), utilise <b>Mapper les colonnes</b>.</li>
        <li>Les lignes <b>sans prix</b> sont ignorées. Les <b>codes article</b> éventuels en début de libellé sont retirés.</li>
      </ol>
      <p>Après import, ajoute les articles au panier, puis utilise le bouton <b>Envoyer par email</b> pour générer un mail prêt à l’envoi.</p>
    </div>
  </section>

  <div class="footer">UTILE ENTRAIGUES — Application de commande Fruits & Légumes</div>
</div>

<script>
let rawMatrix=[], headers=[], rows=[], cart=[];
let customMapping=null; // {fam, des, prix} : index des colonnes

function go(page){
  const ids = ["Catalog","Cart","Help"];
  ids.forEach(id => {
    document.getElementById("page"+id).classList.toggle("hidden", page.toLowerCase()!==id.toLowerCase());
    document.getElementById("tab"+id).classList.toggle("active", page.toLowerCase()===id.toLowerCase());
  });
  if(page==="cart") drawCart();
}

function toggleMapper(){
  document.getElementById("mapper").classList.toggle("hidden");
  if(!headers.length) document.getElementById("headersPreview").textContent = "Aucun en-tête détecté pour l’instant.";
}

function showMsg(txt){ const s=document.getElementById("status"); s.textContent=txt; s.classList.remove("hidden"); }
function hideMsg(){ const s=document.getElementById("status"); s.classList.add("hidden"); }
function norm(s){ return String(s||"").trim().toLowerCase(); }

function findHeaderRow(matrix){
  const KEYS = ["famille","famille produit","désignation","designation","produit","libellé","libelle","prix","tarif"];
  const scan = Math.min(10, matrix.length);
  let best = {row:0, hits:0};
  for(let r=0;r<scan;r++){
    const lower = (matrix[r]||[]).map(norm);
    let hits = 0;
    for(const k of KEYS){ if(lower.some(c => c.includes(k))) hits++; }
    if(hits > best.hits){ best = {row:r, hits}; }
  }
  return best.row;
}

function headerMap(h){
  const s = norm(h);
  if(s.includes("famille")) return "famille";
  if(s.includes("désignation") || s.includes("designation") || s.includes("produit") || s.includes("libell")) return "designation";
  if(s.includes("prix") || s.includes("tarif")) return "prix";
  return null;
}

function populateMapperSelects(){
  const fam = document.getElementById("selFamille");
  const des = document.getElementById("selDesignation");
  const prix = document.getElementById("selPrix");
  fam.innerHTML = des.innerHTML = prix.innerHTML = "";
  headers.forEach((h,i)=>{
    [fam,des,prix].forEach(sel=>{
      const opt=document.createElement("option");
      opt.value=i; opt.textContent=h||(`Col ${i+1}`);
      sel.appendChild(opt);
    });
  });
  document.getElementById("headersPreview").textContent = "En-têtes détectés : " + headers.map(h=>`[${h}]`).join(" ");
}

function applyMapping(){
  const fam = parseInt(document.getElementById("selFamille").value,10);
  const des = parseInt(document.getElementById("selDesignation").value,10);
  const prix = parseInt(document.getElementById("selPrix").value,10);
  customMapping = {fam, des, prix};
  parseRows();
  draw();
}

function parseWithAutoMapping(matrix){
  const headerRow = findHeaderRow(matrix);
  headers = (matrix[headerRow]||[]).map(v=>v==null?"":String(v));
  populateMapperSelects();
  const keys = headers.map(headerMap);
  const idxFam = keys.indexOf("famille");
  const idxDes = keys.indexOf("designation");
  const idxPrix = keys.indexOf("prix");
  return {headerRow, idxFam, idxDes, idxPrix};
}

function stripArticleCode(s){
  // retire code article en début de chaîne (ex: "123456 TOMATE Roma 6kg")
  return String(s||"").replace(/^[A-Z0-9\-]{4,}\s+/, "").trim();
}

function parseRows(){
  if(!rawMatrix.length) return;
  rows = [];
  let headerRow=0, idxFam=-1, idxDes=-1, idxPrix=-1;

  if(customMapping){
    headerRow = 0;
    idxFam = customMapping.fam;
    idxDes = customMapping.des;
    idxPrix = customMapping.prix;
  } else {
    const auto = parseWithAutoMapping(rawMatrix);
    headerRow = auto.headerRow; idxFam = auto.idxFam; idxDes = auto.idxDes; idxPrix = auto.idxPrix;
  }

  for(let r = headerRow + 1; r < rawMatrix.length; r++){
    const row = rawMatrix[r]||[];
    const fam = idxFam>=0 ? String(row[idxFam]||"") : "";
    const des = idxDes>=0 ? String(row[idxDes]||"") : "";
    const prixRaw = idxPrix>=0 ? String(row[idxPrix]||"") : "";
    if(!des.trim()) continue;

    // skip lignes sans prix
    const priceMatch = prixRaw.match(/(\d+[.,]\d{1,2})/);
    if(!priceMatch) continue;
    const prix = priceMatch[1].replace(",", ".");

    rows.push({
      id:String(r),
      famille:fam,
      designation: stripArticleCode(des),
      prix: prix
    });
  }

  // tri par famille puis désignation
  rows.sort((a,b)=> (a.famille||"").localeCompare(b.famille||"") || a.designation.localeCompare(b.designation));
  // KPI
  document.getElementById("kpiItems").textContent = rows.length;
  const famSet = new Set(rows.map(r=>r.famille||""));
  document.getElementById("kpiFamilies").textContent = famSet.size;
}

function handleCSV(text){
  const lines = text.split(/\r?\n/);
  // autodétecte ; ou , 
  const sep = (lines[0] && lines[0].split(";").length>1) ? ";" : ",";
  const matrix = lines.map(l => l.split(sep));
  rawMatrix = matrix;
  parseRows();
}

function handleXLSX(arrayBuffer){
  const wb = XLSX.read(new Uint8Array(arrayBuffer), {type:"array"});
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];
  const matrix = XLSX.utils.sheet_to_json(ws, {header:1, raw:true});
  rawMatrix = matrix;
  parseRows();
}

function onFile(e){
  hideMsg();
  customMapping = null;
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const ext = (f.name.split(".").pop()||"").toLowerCase();
  const reader = new FileReader();
  reader.onerror = () => showMsg("Lecture du fichier impossible. Essaie un autre navigateur ou réenregistre le fichier.");
  if(ext==="csv"){
    reader.onload = ev => { handleCSV(ev.target.result); draw(); };
    reader.readAsText(f, "utf-8");
  } else {
    reader.onload = ev => { handleXLSX(ev.target.result); draw(); };
    reader.readAsArrayBuffer(f);
  }
}

document.getElementById("file").addEventListener("change", onFile);

function draw(){
  const g=document.getElementById("grid");
  if(!rows.length){
    g.innerHTML='<div class="msg">Importe un CSV/Excel. Besoin d’aider l’outil ? Clique <b>Mapper les colonnes</b>.</div>';
    return;
  }
  g.innerHTML = rows.map(r=>`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <span class="pill">${(r.famille||"&nbsp;")}</span>
        <small style="color:#64748b">${r.prix} €</small>
      </div>
      <div style="margin-top:6px;font-weight:600">${r.designation}</div>
      <div class="row" style="margin-top:8px">
        <input type="number" id="q_${r.id}" placeholder="Qté" min="0" step="1" style="width:100px">
        <select id="u_${r.id}">
          <option selected>colis</option>
          <option>kilo</option>
          <option>pièce</option>
        </select>
        <button class="primary" onclick='add("${r.id}")'>Ajouter</button>
      </div>
    </div>
  `).join("");
}

function add(id){
  const qEl = document.getElementById("q_"+id);
  const uEl = document.getElementById("u_"+id);
  const q = Number(qEl.value);
  if(!q || q<=0) return;
  const u = uEl.value;
  const r = rows.find(x=>x.id===id);
  cart.push({famille:r.famille, designation:r.designation, quantite:q, unite:u});
  qEl.value="";
  drawCart();
  go('cart');
}

function drawCart(){
  const body = document.getElementById("cartBody");
  if(!body) return;
  if(!cart.length){ body.innerHTML = '<tr><td colspan="5"><div class="msg">Panier vide</div></td></tr>'; return; }
  body.innerHTML = cart.map((it,idx)=>`
    <tr>
      <td>${it.famille||""}</td>
      <td>${it.designation}</td>
      <td>${it.quantite}</td>
      <td>${it.unite}</td>
      <td><button onclick="removeCart(${idx})">Retirer</button></td>
    </tr>
  `).join("");
}

function removeCart(i){
  cart.splice(i,1);
  drawCart();
}

function exportCartCSV(){
  if(!cart.length){ alert("Panier vide"); return; }
  const header = "Famille,Designation,Quantite,Unite\n";
  const lines = cart.map(it => [it.famille, it.designation, it.quantite, it.unite]
    .map(v => `"${String(v||"").replace(/"/g,'""')}"`).join(","));
  const csv = header + lines.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "commande_panier.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

function sendEmail(){
  if(!cart.length){ alert("Panier vide"); return; }
  const to = document.getElementById("mailto").value || "";
  const subject = encodeURIComponent("Commande Fruits & Légumes");
  const lignes = cart.map(it => `- ${it.designation} : ${it.quantite} ${it.unite}`).join('%0D%0A');
  const body = encodeURIComponent("Bonjour,%0D%0A%0D%0AMerci de préparer la commande :%0D%0A") + lignes + encodeURIComponent("%0D%0A%0D%0ACordialement,");
  window.location.href = `mailto:${encodeURIComponent(to)}?subject=${subject}&body=${body}`;
}
</script>
</body>
</html>
