<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Commande Fruits & Légumes — UTILE ENTRAIGUES</title>
<style>
  body{font-family:Arial,sans-serif;background:#f6f7f9;margin:0;padding:20px}
  .container{max-width:1100px;margin:auto}
  .nav{display:flex;gap:10px;margin-bottom:20px}
  .tab{padding:10px 15px;border:1px solid #ddd;background:#fff;cursor:pointer;border-radius:8px;transition:.15s}
  .tab.active,.tab:hover{background:#28a745;color:#fff;border-color:#28a745}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
  .card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:12px}
  .msg{padding:10px;border-radius:8px;border:1px solid #ffe08a;background:#fff8db;color:#8a5b00}
  .footer{text-align:center;font-size:12px;color:#555;margin-top:20px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef6ff;border:1px solid #cfe0ff;color:#2952cc;font-size:12px}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid #28a745;background:#28a745;color:#fff;cursor:pointer}
  .btn.outline{background:#fff;color:#28a745}
  .tools{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .filter{margin:10px 0}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
  <div class="nav">
    <button class="tab active" id="tabCatalog" onclick="go('catalog')">Catalogue</button>
    <button class="tab" id="tabCart" onclick="go('cart')">Panier</button>
  </div>

  <section id="pageCatalog">
    <div class="card">
      <div class="row">
        <input type="file" id="file" accept=".xlsx,.xls,.csv"/>
        <span id="status" class="msg" style="display:none"></span>
      </div>
      <div class="filter">
        <label>Filtrer par famille/groupe :</label>
        <select id="familyFilter" onchange="draw()">
          <option value="">Toutes</option>
        </select>
      </div>
    </div>
    <div id="grid" class="grid"></div>
  </section>

  <section id="pageCart" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between;width:100%">
        <h2 style="margin:0">Panier</h2>
        <div class="tools">
          <button class="btn outline" onclick="exportCSV()">Exporter CSV</button>
          <button class="btn outline" onclick="exportPDF()">Exporter PDF</button>
          <button class="btn outline" onclick="sendEmail()">Envoyer par email</button>
        </div>
      </div>
      <div id="cart"></div>
    </div>
  </section>

  <div class="footer">UTILE ENTRAIGUES — Application de commande Fruits & Légumes</div>
</div>

<script>
// ----------------------
// CONFIG SUPABASE (COLLE ICI TES VALEURS)
// ----------------------
const SUPABASE_URL = "https://edwmlqxunjgjxavxsbza.supabase.co";  // <= remplace
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkd21scXh1bmpnanhhdnhzYnphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NjU0MTksImV4cCI6MjA3MjA0MTQxOX0.I0ZYBbQnIrWmSo3Kue23oXsKC0Vh83usNYV_ujtktxc";               // <= remplace
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Tables et id unique (un seul utilisateur)
const TABLE_CATALOGUE = "catalogue";
const TABLE_PANIER = "panier";
const SINGLE_ID = 1;

let rows = [];   // catalogue en mémoire
let cart = [];   // panier en mémoire

// ---------- NAV ----------
function go(page){
  document.getElementById("pageCatalog").style.display = page==="catalog" ? "" : "none";
  document.getElementById("pageCart").style.display    = page==="cart"    ? "" : "none";
  document.getElementById("tabCatalog").classList.toggle("active", page==="catalog");
  document.getElementById("tabCart").classList.toggle("active", page==="cart");
  if(page==="cart") drawCart();
}

function showMsg(txt){ const s=document.getElementById("status"); s.textContent=txt; s.style.display='inline-block'; }
function hideMsg(){ document.getElementById("status").style.display='none'; }
const norm = s => String(s||"").trim().toLowerCase();

// ---------- PARSING ----------
function findHeaderRow(matrix){
  // On reconnaît les colonnes 'désignation|designation|libellé|produit' et 'famille|groupe'
  const KEYS = ["famille","groupe","désignation","designation","produit","libellé","libelle"];
  const maxScan = Math.min(12, matrix.length);
  for(let r=0; r<maxScan; r++){
    const lower = (matrix[r]||[]).map(norm);
    let hits = 0;
    for(const k of KEYS){ if(lower.some(c => c.includes(k))) hits++; }
    if(hits >= 2) return r;
  }
  return 0;
}
function headerMap(h){
  const s = norm(h);
  if(s.includes("famille") || s.includes("groupe")) return "famille";
  if(s.includes("désignation") || s.includes("designation") || s.includes("produit") || s.includes("libell")) return "designation";
  return null;
}
function parseMatrix(matrix){
  if(!matrix.length){ rows=[]; return; }
  const headerRow = findHeaderRow(matrix);
  const keys = (matrix[headerRow]||[]).map(headerMap);
  const idxFam = keys.indexOf("famille");
  const idxDes = keys.indexOf("designation");

  const out = [];
  for(let r = headerRow+1; r < matrix.length; r++){
    const row = matrix[r]||[];
    const fam = idxFam>=0 && row[idxFam]!=null ? String(row[idxFam]) : "";
    const des = idxDes>=0 && row[idxDes]!=null ? String(row[idxDes]) : "";
    if(des.trim()==="") continue;
    out.push({ id:String(r), famille:fam, designation:des });
  }
  rows = out;
  refreshFamilyFilter();
}
function handleCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim()!=="");
  const sep = (lines[0] && lines[0].split(";").length>1) ? ";" : ",";
  const matrix = lines.map(l => l.split(sep));
  parseMatrix(matrix);
}
function handleXLSX(arrayBuffer){
  const wb = XLSX.read(new Uint8Array(arrayBuffer), {type:"array"});
  const ws = wb.Sheets[wb.SheetNames[0]];
  const matrix = XLSX.utils.sheet_to_json(ws, {header:1, raw:true});
  parseMatrix(matrix);
}
function onFile(e){
  hideMsg();
  const f = e.target.files?.[0];
  if(!f) return;
  const ext = (f.name.split(".").pop()||"").toLowerCase();
  const reader = new FileReader();
  reader.onerror = () => showMsg("Lecture du fichier impossible.");
  if(ext==="csv"){
    reader.onload = ev => { handleCSV(ev.target.result); afterImport(); };
    reader.readAsText(f, "utf-8");
  } else {
    reader.onload = ev => { handleXLSX(ev.target.result); afterImport(); };
    reader.readAsArrayBuffer(f);
  }
}
document.getElementById("file").addEventListener("change", onFile);

function afterImport(){
  if(!rows.length){ showMsg("Aucun produit détecté."); }
  else { hideMsg(); saveCatalogueToDB(); }
  draw();
}

// ---------- UI ----------
function refreshFamilyFilter(){
  const sel = document.getElementById("familyFilter");
  const current = sel.value;
  const families = Array.from(new Set(rows.map(r => r.famille).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'fr'));
  sel.innerHTML = `<option value="">Toutes</option>` + families.map(f=>`<option>${escapeHTML(f)}</option>`).join("");
  if(current && families.includes(current)) sel.value = current;
}
function escapeHTML(s){ return (s||"").replace(/[&<>'"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;" }[m])); }

function draw(){
  const g=document.getElementById("grid");
  if(!rows.length){
    g.innerHTML='<div class="msg">Importe un fichier CSV/Excel avec au minimum les colonnes <b>Désignation</b> et <b>Famille/Groupe</b>.</div>';
    return;
  }
  const famFilter = document.getElementById("familyFilter").value || "";
  const list = famFilter ? rows.filter(r => (r.famille||"")===famFilter) : rows;

  g.innerHTML = list.map(r=>`
    <div class="card">
      <div class="pill">${escapeHTML(r.famille||"Sans famille")}</div>
      <div style="margin:6px 0 8px 0"><b>${escapeHTML(r.designation)}</b></div>
      <div class="row">
        <input type='number' id='q_${r.id}' value='1' min='1' style="width:90px">
        <select id='u_${r.id}'>
          <option>colis</option>
          <option>kilo</option>
          <option>pièce</option>
        </select>
        <button class="btn" onclick='add("${r.id}")'>Ajouter</button>
      </div>
    </div>`).join("");
}

function add(id){
  const q = Number(document.getElementById("q_"+id).value)||1;
  const u = document.getElementById("u_"+id).value;
  const r = rows.find(x=>x.id===id);
  if(!r) return;
  cart.push({ designation:r.designation, quantite:q, unite:u });
  drawCart();
  saveCartToDB();
}

function drawCart(){
  const c=document.getElementById("cart");
  if(!cart.length){ c.innerHTML='<div class="msg">Panier vide</div>'; return; }
  c.innerHTML = cart.map((it,idx)=>`
    <div class="row" style="justify-content:space-between;border-bottom:1px dashed #eee;padding:6px 0">
      <div><b>${escapeHTML(it.designation)}</b> — ${it.quantite} ${escapeHTML(it.unite)}</div>
      <button class="btn outline" onclick="removeLine(${idx})">Supprimer</button>
    </div>
  `).join("");
}
function removeLine(i){
  cart.splice(i,1);
  drawCart();
  saveCartToDB();
}

// ---------- EXPORTS ----------
function exportCSV(){
  if(!cart.length) return alert("Panier vide");
  const header = ["designation","quantite","unite"];
  const lines = [header.join(";")].concat(
    cart.map(it => [it.designation, it.quantite, it.unite].map(v=>String(v).replace(/;/g, ",")).join(";"))
  );
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "commande.csv";
  a.click();
}
async function exportPDF(){
  // Astuce minimale : ouvre une nouvelle fenêtre de print
  const win = window.open("", "_blank");
  const html = `
    <html><head><title>Commande</title></head><body>
    <h3>Commande — UTILE ENTRAIGUES</h3>
    <ul>${cart.map(it=>`<li>${escapeHTML(it.designation)} — ${it.quantite} ${escapeHTML(it.unite)}</li>`).join("")}</ul>
    </body></html>`;
  win.document.write(html);
  win.document.close();
  win.focus();
  win.print();
}
function sendEmail(){
  // Sans backend/mail API : on ouvre un mailto (liste en texte)
  if(!cart.length) return alert("Panier vide");
  const body = cart.map(it=>`${it.designation} — ${it.quantite} ${it.unite}`).join("%0D%0A");
  window.location.href = `mailto:?subject=Commande Fruits%20%26%20Légumes&body=${body}`;
}

// ---------- SUPABASE PERSISTENCE ----------
async function saveCatalogueToDB(){
  try{
    const { error } = await supabase.from(TABLE_CATALOGUE).upsert({ id:SINGLE_ID, data:rows });
    if(error) console.error("Erreur save catalogue:", error);
  }catch(e){ console.error(e); }
}
async function loadCatalogueFromDB(){
  try{
    const { data, error } = await supabase.from(TABLE_CATALOGUE).select("data").eq("id",SINGLE_ID).maybeSingle();
    if(!error && data?.data){
      rows = data.data || [];
      refreshFamilyFilter();
      draw();
    }
  }catch(e){ console.error(e); }
}
async function saveCartToDB(){
  try{
    await supabase.from(TABLE_PANIER).upsert({ id:SINGLE_ID, data:cart });
  }catch(e){ console.error(e); }
}
async function loadCartFromDB(){
  try{
    const { data, error } = await supabase.from(TABLE_PANIER).select("data").eq("id",SINGLE_ID).maybeSingle();
    if(!error && data?.data){
      cart = data.data || [];
      drawCart();
    }
  }catch(e){ console.error(e); }
}

// ---------- INIT ----------
(async function init(){
  // Vérifier que les clés sont présentes
  if(!SUPABASE_URL.startsWith("http") || SUPABASE_ANON_KEY.length < 20){
    showMsg("Supabase indisponible : colle SUPABASE_URL et SUPABASE_ANON_KEY dans le code.");
    return;
  }
  hideMsg();
  await loadCatalogueFromDB();
  await loadCartFromDB();
})();
</script>
</body>
</html>
