<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Commande Fruits & Légumes — UTILE ENTRAIGUES</title>
<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --text:#111; --muted:#666; --line:#e6e6e6; --primary:#111;
  }
  *{box-sizing:border-box}
  body{font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px}
  .container{max-width:1100px;margin:0 auto}
  .nav{display:flex;gap:10px;margin:0 0 16px}
  .tab{padding:10px 14px;border:1px solid var(--line);background:#fff;border-radius:10px;cursor:pointer}
  .tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
  .msg{padding:10px;border-radius:10px;border:1px solid #ffe08a;background:#fff8db;color:#7a5600}
  .muted{color:var(--muted);font-size:12px}
  input[type="number"]{width:100px;padding:8px;border:1px solid var(--line);border-radius:8px}
  select{padding:8px;border:1px solid var(--line);border-radius:8px}
  button{padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
  button.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  h2{margin:10px 0}
  .footer{margin-top:20px;text-align:center;color:var(--muted);font-size:12px}
  .groupTitle{font-weight:bold;margin:14px 0 6px}
  .line{border-top:1px dashed var(--line);margin:8px 0}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
</style>
<!-- XLSX pour Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<!-- jsPDF pour export PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
<div class="container">
  <div class="nav">
    <button id="tabCatalog" class="tab active" onclick="go('catalog')">Catalogue</button>
    <button id="tabCart" class="tab" onclick="go('cart')">Panier</button>
  </div>

  <!-- Catalogue -->
  <section id="pageCatalog">
    <div class="card" style="margin-bottom:10px">
      <div class="row">
        <input type="file" id="file" accept=".csv,.xlsx,.xls" />
        <span id="status" class="msg" style="display:none"></span>
        <span class="muted">Colonnes attendues : <b>Famille</b> (ou Groupe/Département) et <b>Désignation</b>.</span>
      </div>
    </div>
    <div id="grid" class="grid"></div>
  </section>

  <!-- Panier -->
  <section id="pageCart" style="display:none">
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <h2>Panier</h2>
      <div class="row">
        <button onclick="clearCart()">Vider</button>
        <button class="primary" onclick="exportPDF()">Exporter la commande en PDF</button>
      </div>
    </div>
    <div id="cart"></div>
  </section>

  <div class="footer">UTILE ENTRAIGUES — Application de commande Fruits &amp; Légumes</div>
</div>

<script>
  // ---------- ÉTAT ----------
  let rows = []; // {id, famille, designation}
  let cart = []; // {id, famille, designation, quantite, unite}

  // ---------- NAV ----------
  function go(page){
    const cat = document.getElementById('pageCatalog');
    const crt = document.getElementById('pageCart');
    cat.style.display = page === 'catalog' ? '' : 'none';
    crt.style.display = page === 'cart' ? '' : 'none';
    document.getElementById('tabCatalog').classList.toggle('active', page==='catalog');
    document.getElementById('tabCart').classList.toggle('active', page==='cart');
    if(page==='cart') drawCart();
  }

  // ---------- UI helpers ----------
  function showMsg(t){ const s=document.getElementById('status'); s.textContent=t; s.style.display='inline-block'; }
  function hideMsg(){ const s=document.getElementById('status'); s.style.display='none'; }
  const norm = s => String(s ?? '').trim();
  const lower = s => norm(s).toLowerCase();

  // ---------- Détection des colonnes ----------
  function findHeaderRow(matrix){
    // scanne les 8 premières lignes pour trouver une ligne d'en-têtes plausible
    const MAX = Math.min(8, matrix.length);
    const wanted = ['famille','groupe','departement','département','designation','désignation','libellé','libelle','produit'];
    for(let r=0;r<MAX;r++){
      const cells = (matrix[r]||[]).map(c => lower(c));
      let hits = 0;
      for(const w of wanted){ if(cells.some(c => c.includes(w))) hits++; }
      if(hits >= 2) return r;
    }
    return 0; // fallback
  }

  function mapHeader(h){
    const s = lower(h).normalize('NFD').replace(/\p{Diacritic}/gu,'');
    // Famille
    if(s.includes('famille') || s.includes('groupe') || s.includes('departement')) return 'famille';
    // Désignation
    if(s.includes('designation') || s.includes('libelle') || s.includes('produit')) return 'designation';
    return null;
  }

  function parseMatrix(matrix){
    rows = [];
    if(!matrix.length) return;
    const headerRow = findHeaderRow(matrix);
    const headers = (matrix[headerRow]||[]).map(h=>h==null?'':String(h));
    const keys = headers.map(mapHeader);

    const iFam = keys.indexOf('famille');
    const iDes = keys.indexOf('designation');

    for(let r=headerRow+1; r<matrix.length; r++){
      const row = matrix[r] || [];
      const fam = iFam>=0 ? norm(row[iFam]) : '';
      const des = iDes>=0 ? norm(row[iDes]) : '';
      if(!des) continue; // ignore lignes sans désignation
      rows.push({ id:String(r), famille:fam, designation:des });
    }
  }

  // ---------- Import CSV/XLSX ----------
  function handleCSV(text){
    // détecte ; ou , automatiquement
    const firstLine = text.split(/\r?\n/)[0] || '';
    const sep = (firstLine.split(';').length > firstLine.split(',').length) ? ';' : ',';
    const matrix = text.split(/\r?\n/).map(l => l.split(sep));
    parseMatrix(matrix);
  }

  function handleXLSX(arrayBuffer){
    const wb = XLSX.read(new Uint8Array(arrayBuffer), {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const matrix = XLSX.utils.sheet_to_json(ws, {header:1, raw:true});
    parseMatrix(matrix);
  }

  function onFile(e){
    hideMsg();
    const f = e.target.files?.[0];
    if(!f) return;
    const ext = (f.name.split('.').pop()||'').toLowerCase();
    const reader = new FileReader();
    reader.onerror = () => showMsg('Lecture du fichier impossible. Réessaie ou exporte en CSV.');
    if(ext === 'csv'){
      reader.onload = ev => { handleCSV(String(ev.target.result)); afterImport(); };
      reader.readAsText(f, 'utf-8');
    }else{
      reader.onload = ev => { handleXLSX(ev.target.result); afterImport(); };
      reader.readAsArrayBuffer(f);
    }
  }
  document.getElementById('file').addEventListener('change', onFile);

  function afterImport(){
    if(!rows.length){
      showMsg("Aucun produit détecté. Vérifie que les en-têtes contiennent 'Famille' (ou Groupe/Département) et 'Désignation'.");
    }else{
      hideMsg();
    }
    drawCatalog();
  }

  // ---------- Rendu Catalogue ----------
  function drawCatalog(){
    const g = document.getElementById('grid');
    if(!rows.length){
      g.innerHTML = '<div class="card msg">Importe un fichier CSV/Excel contenant au moins <b>Famille</b> et <b>Désignation</b>.</div>';
      return;
    }
    // Affichage groupé par famille
    const byFam = {};
    for(const r of rows){
      const fam = r.famille || 'Divers';
      (byFam[fam] ||= []).push(r);
    }
    let html = '';
    for(const fam of Object.keys(byFam).sort((a,b)=>a.localeCompare(b,'fr'))){
      html += `<div class="grid" style="grid-column:1/-1"><div class="groupTitle">${fam}</div></div>`;
      html += byFam[fam]
        .sort((a,b)=>a.designation.localeCompare(b.designation,'fr'))
        .map(r => card(r)).join('');
    }
    g.innerHTML = html;
  }

  function card(r){
    return `
      <div class="card">
        <div style="font-weight:bold;margin-bottom:4px">${escapeHTML(r.designation)}</div>
        <div class="row">
          <input type="number" min="0" step="1" placeholder="Qté" id="q_${r.id}">
          <select id="u_${r.id}">
            <option value="colis" selected>colis</option>
            <option value="kilo">kilo</option>
            <option value="pièce">pièce</option>
          </select>
          <button onclick="addToCart('${r.id}')" class="primary">Ajouter</button>
        </div>
      </div>
    `;
  }

  // ---------- Panier ----------
  function addToCart(id){
    const q = Number(document.getElementById('q_'+id).value);
    const u = document.getElementById('u_'+id).value;
    if(!q) return;
    const r = rows.find(x=>x.id===id);
    cart.push({ ...r, quantite:q, unite:u });
    document.getElementById('q_'+id).value = '';
    go('cart');
  }

  function drawCart(){
    const wrap = document.getElementById('cart');
    if(!cart.length){
      wrap.innerHTML = '<div class="msg">Panier vide</div>';
      return;
    }
    // groupe par famille
    const byFam = {};
    for(const it of cart){ (byFam[it.famille||'Divers'] ||= []).push(it); }
    let html = '';
    for(const fam of Object.keys(byFam).sort((a,b)=>a.localeCompare(b,'fr'))){
      html += `<div class="groupTitle">${fam}</div>`;
      html += `<table class="table"><thead><tr><th>Produit</th><th>Qté</th><th>Unité</th><th></th></tr></thead><tbody>`;
      for(const it of byFam[fam]){
        html += `<tr>
          <td>${escapeHTML(it.designation)}</td>
          <td>${it.quantite}</td>
          <td>${it.unite}</td>
          <td><button onclick="removeFromCart('${it.id}', ${it.quantite}, '${it.unite}')">Supprimer</button></td>
        </tr>`;
      }
      html += `</tbody></table><div class="line"></div>`;
    }
    wrap.innerHTML = html;
  }

  function removeFromCart(id, q, u){
    const i = cart.findIndex(c=>c.id===id && c.quantite===q && c.unite===u);
    if(i>=0){ cart.splice(i,1); drawCart(); }
  }
  function clearCart(){ cart = []; drawCart(); }

  // ---------- Export PDF ----------
  async function exportPDF(){
    if(!cart.length) return alert('Panier vide.');
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' }); // portrait A4
    const left = 40, top = 40, lineH = 18;
    let y = top;

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('UTILE ENTRAIGUES — Commande Fruits & Légumes', left, y); y += 20;
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    doc.text(new Date().toLocaleString('fr-FR'), left, y); y += 18;

    // Regroupe par famille
    const byFam = {};
    cart.forEach(it => (byFam[it.famille||'Divers'] ||= []).push(it));

    for(const fam of Object.keys(byFam).sort((a,b)=>a.localeCompare(b,'fr'))){
      y += 10;
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text(String(fam||'Divers'), left, y); y += 10;
      doc.setFont('helvetica','normal'); doc.setFontSize(10);

      for(const it of byFam[fam]){
        const line = `• ${it.designation} — ${it.quantite} ${it.unite}`;
        // gestion saut de page
        if(y > 780){ doc.addPage(); y = top; }
        wrapText(doc, line, left, y, 515, lineH); // 595-2*40 = 515
        y += lineH;
      }
      if(y > 780){ doc.addPage(); y = top; }
    }

    doc.save('commande_fruits_legumes.pdf');
  }

  // Utilitaires
  function wrapText(doc, text, x, y, maxWidth, lineHeight){
    const words = text.split(' ');
    let line = '';
    for(let n=0;n<words.length;n++){
      const testLine = line + words[n] + ' ';
      const width = doc.getTextWidth(testLine);
      if(width > maxWidth && n>0){
        doc.text(line, x, y);
        line = words[n] + ' ';
        y += lineHeight;
      }else{
        line = testLine;
      }
    }
    doc.text(line, x, y);
    return y;
  }
  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c]));
  }
</script>
</body>
</html>
