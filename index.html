<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Commande Fruits & Légumes — UTILE ENTRAIGUES</title>
<style>
  :root{
    --green:#16a34a;
    --green-600:#16a34a;
    --green-700:#15803d;
    --bg:#f6f7f9;
    --card:#ffffff;
    --border:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --warn-bg:#fff8db;
    --warn-bd:#ffe08a;
  }
  *{box-sizing:border-box}
  body{font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);margin:0;padding:20px;color:var(--text)}
  .container{max-width:1100px;margin:auto}
  .nav{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
  .tab{padding:10px 14px;border:1px solid var(--border);background:var(--card);cursor:pointer;border-radius:10px}
  .tab.active{background:var(--green-600);color:#fff;border-color:var(--green-600)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
  .msg{padding:10px;border-radius:10px;border:1px solid var(--warn-bd);background:var(--warn-bg);color:#8a5b00}
  .footer{text-align:center;font-size:12px;color:var(--muted);margin-top:22px}
  input[type="number"], input[type="text"], select{
    border:1px solid var(--border);border-radius:10px;padding:8px 10px;outline:none
  }
  .btn{
    background:var(--green-600);color:#fff;border:none;border-radius:10px;padding:9px 14px;cursor:pointer
  }
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn-outline{background:#fff;color:var(--green-700);border:1px solid var(--green-600)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef6f0;color:#1f6a37;font-size:12px;border:1px solid #d7eddc}
  .list{display:flex;flex-direction:column;gap:10px}
  .line{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff}
  .line .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap;min-width:0}
  .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px}
  .qty{display:flex;gap:6px;align-items:center}
  .spacer{flex:1}
  small.muted{color:var(--muted)}
</style>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
<div class="container">

  <div class="nav">
    <button class="tab active" id="tabCatalog" onclick="go('catalog')">Catalogue</button>
    <button class="tab" id="tabCart" onclick="go('cart')">Panier</button>
    <span class="spacer"></span>
    <small id="syncState" class="muted">Sync: hors ligne</small>
  </div>

  <!-- CATALOGUE -->
  <section id="pageCatalog">
    <div class="card" style="margin-bottom:10px">
      <div class="row">
        <input type="file" id="file" accept=".xlsx,.xls,.csv"/>
        <button class="btn" onclick="saveCatalogRemote()" title="Sauvegarder le catalogue en ligne">Sauvegarder en ligne</button>
        <span id="status" class="msg" style="display:none"></span>
      </div>
      <div class="row" style="margin-top:10px">
        <select id="filterFamily" onchange="drawCatalog()">
          <option value="">Toutes les familles</option>
        </select>
        <input id="search" type="text" placeholder="Rechercher un produit…" oninput="drawCatalog()"/>
      </div>
    </div>
    <div id="grid" class="grid"></div>
  </section>

  <!-- PANIER -->
  <section id="pageCart" style="display:none">
    <div class="card" style="margin-bottom:10px">
      <div class="row">
        <button class="btn" onclick="exportCartCSV()">Exporter CSV</button>
        <button class="btn" onclick="exportCartPDF()">Exporter PDF</button>
        <button class="btn btn-outline" onclick="sendCartEmail()">Envoyer par email</button>
        <button class="btn btn-outline" onclick="clearCart()">Vider</button>
      </div>
    </div>
    <div id="cart" class="list"></div>
  </section>

  <div class="footer">UTILE ENTRAIGUES — Application de commande Fruits & Légumes</div>
</div>

<script>
/** ===================== SUPABASE CONFIG ===================== **/
const SUPABASE_URL = "https://edwmlqxunjgjxavxsbza.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkd21scXh1bmpnanhhdnhzYnphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NjU0MTksImV4cCI6MjA3MjA0MTQxOX0.I0ZYBbQnIrWmSo3Kue23oXsKC0Vh83usNYV_ujtktxc";
let supa = null;
let supaReady = false;
let profileKey = "default"; // on pourra passer à un vrai auth plus tard

async function initSupabase(){
  try{
    supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // ping léger: lister une table; si pas encore créée, on le dira dans l'UI
    supaReady = true;
    document.getElementById('syncState').textContent = "Sync: prêt";
  }catch(e){
    supaReady = false;
    document.getElementById('syncState').textContent = "Sync: désactivé";
  }
}

// Tables attendues : catalogs(id text pk, data jsonb), carts(id text pk, data jsonb)
// SQL à créer côté Supabase (une fois):
// create table if not exists catalogs (id text primary key, data jsonb);
// create table if not exists carts (id text primary key, data jsonb);

async function saveCatalogRemote(){
  if(!supaReady){ showMsg("Supabase indisponible, sauvegarde locale uniquement."); return; }
  try{
    await supa.from('catalogs').upsert({id: profileKey, data: rows});
    showMsg("Catalogue sauvegardé en ligne.");
    setTimeout(hideMsg, 2000);
  }catch(e){
    showMsg("Échec sauvegarde en ligne. ("+e.message+")");
  }
}

async function loadCatalogRemote(){
  if(!supaReady) return null;
  const { data, error } = await supa.from('catalogs').select('data').eq('id', profileKey).maybeSingle();
  if(error) return null;
  return data ? data.data : null;
}

async function saveCartRemote(){
  if(!supaReady) return;
  try{
    await supa.from('carts').upsert({id: profileKey, data: cart});
    document.getElementById('syncState').textContent = "Sync: panier sauvegardé";
  }catch(e){
    document.getElementById('syncState').textContent = "Sync: erreur panier";
  }
}

async function loadCartRemote(){
  if(!supaReady) return null;
  const { data, error } = await supa.from('carts').select('data').eq('id', profileKey).maybeSingle();
  if(error) return null;
  return data ? data.data : null;
}

/** ===================== STATE ===================== **/
let rows = [];         // [{id, designation, famille}]
let cart = [];         // [{id, designation, unite, quantite}]
let families = [];     // uniques

function go(page){
  document.getElementById("pageCatalog").style.display = page==="catalog"?"":"none";
  document.getElementById("pageCart").style.display    = page==="cart"?"":"none";
  document.getElementById("tabCatalog").classList.toggle("active", page==="catalog");
  document.getElementById("tabCart").classList.toggle("active", page==="cart");
  if(page==="cart") drawCart();
}

function showMsg(txt){ const s=document.getElementById("status"); s.textContent=txt; s.style.display='inline-block'; }
function hideMsg(){ const s=document.getElementById("status"); s.style.display='none'; }
const norm = s => String(s||"").trim();

/** ===================== IMPORT PARSE ===================== **/
function buildFromMatrix(matrix){
  // Attend: colonne B = Désignation, colonne P = Groupe/Famille
  // On détecte auto par header OU par index (B=1, P=15) si pas de header.
  let header = matrix[0]?.map(v=>norm(v).toLowerCase()) || [];
  let idxDes = header.findIndex(h => h.includes('désignation') || h.includes('designation'));
  let idxGrp = header.findIndex(h => h.includes('groupe') || h.includes('famille'));
  let start = 1;
  if(idxDes<0 && idxGrp<0){ idxDes = 1; idxGrp = 15; start = 0; } // fallback B & P

  const out=[];
  for(let r=start; r<matrix.length; r++){
    const row = matrix[r]||[];
    const designation = norm(row[idxDes]);
    const famille = norm(row[idxGrp]);
    if(!designation) continue;
    out.push({ id: String(r), designation, famille });
  }
  rows = out;
  localStorage.setItem('catalog_rows', JSON.stringify(rows));
  rebuildFamilies();
}

function handleCSV(text){
  const lines = text.split(/\r?\n/);
  const sep = (lines[0] && lines[0].split(";").length>1) ? ";" : ",";
  const matrix = lines.map(l => l.split(sep));
  buildFromMatrix(matrix);
}

function handleXLSX(arrayBuffer){
  const wb = XLSX.read(new Uint8Array(arrayBuffer), {type:"array"});
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];
  const matrix = XLSX.utils.sheet_to_json(ws, {header:1, raw:true});
  buildFromMatrix(matrix);
}

function onFile(e){
  hideMsg();
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const ext = (f.name.split(".").pop()||"").toLowerCase();
  const reader = new FileReader();
  reader.onerror = () => showMsg("Lecture du fichier impossible.");
  if(ext==="csv"){
    reader.onload = ev => { handleCSV(ev.target.result); afterImport(); };
    reader.readAsText(f, "utf-8");
  } else {
    reader.onload = ev => { handleXLSX(ev.target.result); afterImport(); };
    reader.readAsArrayBuffer(f);
  }
}

function afterImport(){
  if(!rows.length) showMsg("Aucun produit détecté (attendu: colonnes 'Désignation' et 'Groupe').");
  else { hideMsg(); }
  drawCatalog();
}

/** ===================== CATALOGUE UI ===================== **/
function rebuildFamilies(){
  const set = new Set(rows.map(r=>r.famille).filter(Boolean));
  families = Array.from(set).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
  const sel = document.getElementById('filterFamily');
  sel.innerHTML = `<option value="">Toutes les familles</option>` + families.map(f=>`<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join('');
}

function drawCatalog(){
  const g = document.getElementById("grid");
  if(!rows.length){
    g.innerHTML = `<div class="msg">Importe un fichier CSV/XLSX contenant <b>Désignation</b> (col. B) et <b>Groupe</b> (col. P).</div>`;
    return;
  }
  const q = norm(document.getElementById('search').value).toLowerCase();
  const fam = norm(document.getElementById('filterFamily').value).toLowerCase();

  const list = rows.filter(r=>{
    const inFam = !fam || (norm(r.famille).toLowerCase() === fam);
    const inTxt = !q || r.designation.toLowerCase().includes(q);
    return inFam && inTxt;
  });

  g.innerHTML = list.map(r=>`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <span class="title">${escapeHtml(r.designation)}</span>
        ${r.famille?`<span class="pill">${escapeHtml(r.famille)}</span>`:''}
      </div>
      <div class="row" style="margin-top:8px">
        <div class="qty">
          <input type="number" min="0" id="q_${r.id}" placeholder="Qté" style="width:90px">
          <select id="u_${r.id}">
            <option>colis</option>
            <option>kilo</option>
            <option>pièce</option>
          </select>
        </div>
        <button class="btn" onclick='add("${r.id}")'>Ajouter</button>
      </div>
    </div>
  `).join('');
}

/** ===================== PANIER ===================== **/
function add(id){
  const qEl = document.getElementById("q_"+id);
  const uEl = document.getElementById("u_"+id);
  const q = Number(qEl.value);
  if(!q) return;
  const r = rows.find(x=>x.id===id);
  // fusion si déjà présent même unité
  const ix = cart.findIndex(c=>c.id===id && c.unite===uEl.value);
  if(ix>=0){ cart[ix].quantite += q; }
  else { cart.push({ id:r.id, designation:r.designation, unite:uEl.value, quantite:q }); }
  qEl.value = "";
  persistCart();
  drawCart();
}

function drawCart(){
  const c = document.getElementById("cart");
  if(!cart.length){
    c.innerHTML = `<div class="msg">Panier vide</div>`;
    return;
  }
  c.innerHTML = cart.map((it,idx)=>`
    <div class="line">
      <div class="left">
        <span class="title">${escapeHtml(it.designation)}</span>
        <div class="qty">
          <input type="number" min="0" value="${it.quantite}" style="width:90px" onchange="updateQty(${idx}, this.value)">
          <select onchange="updateUnit(${idx}, this.value)">
            <option ${it.unite==='colis'?'selected':''}>colis</option>
            <option ${it.unite==='kilo'?'selected':''}>kilo</option>
            <option ${it.unite==='pièce'?'selected':''}>pièce</option>
          </select>
        </div>
      </div>
      <button class="btn btn-outline" onclick="removeLine(${idx})">Retirer</button>
    </div>
  `).join('');
}

function updateQty(i,val){
  const n = Number(val)||0;
  cart[i].quantite = n;
  persistCartDebounced();
}

function updateUnit(i,val){
  cart[i].unite = val;
  persistCartDebounced();
}

function removeLine(i){
  cart.splice(i,1);
  persistCart();
  drawCart();
}

function clearCart(){
  cart = [];
  persistCart();
  drawCart();
}

function persistCart(){
  localStorage.setItem('cart', JSON.stringify(cart));
  saveCartRemote();
}
let persistTimer=null;
function persistCartDebounced(){
  clearTimeout(persistTimer);
  persistTimer = setTimeout(()=>persistCart(), 400);
}

/** ===================== EXPORTS ===================== **/
function exportCartCSV(){
  if(!cart.length) return;
  const header = "designation,quantite,unite\n";
  const body = cart.map(it=>[
    csvEscape(it.designation),
    it.quantite,
    csvEscape(it.unite)
  ].join(",")).join("\n");
  downloadBlob(header+body, "commande.csv", "text/csv;charset=utf-8");
}

function exportCartPDF(){
  if(!cart.length) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("Commande — Fruits & Légumes", 14, 16);
  doc.setFontSize(11);

  let y=28;
  cart.forEach((it, idx)=>{
    const line = `${idx+1}. ${it.designation} — ${it.quantite} ${it.unite}`;
    const split = doc.splitTextToSize(line, 180);
    if(y+split.length*6>280){ doc.addPage(); y=20; }
    doc.text(split, 14, y);
    y += split.length*6;
  });

  doc.save("commande.pdf");
}

function sendCartEmail(){
  if(!cart.length) return;
  const subject = encodeURIComponent("Commande Fruits & Légumes");
  const bodyLines = cart.map(it=>`- ${it.designation} : ${it.quantite} ${it.unite}`);
  const body = encodeURIComponent(`Bonjour,\n\nMerci de préparer la commande suivante :\n\n${bodyLines.join("\n")}\n\nCordialement,\n`);
  window.location.href = `mailto:?subject=${subject}&body=${body}`;
}

/** ===================== HELPERS ===================== **/
function csvEscape(s){
  const t = String(s||"");
  if(t.includes(",") || t.includes("\"") || t.includes("\n")){
    return `"${t.replace(/"/g,'""')}"`;
  }
  return t;
}
function downloadBlob(content, filename, type){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/** ===================== BOOT ===================== **/
document.getElementById("file").addEventListener("change", onFile);

async function boot(){
  await initSupabase();

  // 1) Essaye de charger le catalogue en ligne, sinon localStorage
  let remote = await loadCatalogRemote();
  if(remote && Array.isArray(remote) && remote.length){
    rows = remote;
  }else{
    const cached = localStorage.getItem('catalog_rows');
    if(cached){ rows = JSON.parse(cached||"[]"); }
  }
  if(rows.length){ rebuildFamilies(); drawCatalog(); }

  // 2) Recharge panier (en ligne prioritaire)
  let rCart = await loadCartRemote();
  if(rCart && Array.isArray(rCart)){ cart = rCart; }
  else{
    const lc = localStorage.getItem('cart');
    if(lc) cart = JSON.parse(lc||"[]");
  }
}
boot();
</script>
</body>
</html>
