<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Commande Fruits & Légumes — UTILE ENTRAIGUES</title>
<style>
  body{font-family:Arial,sans-serif;background:#f6f7f9;margin:0;padding:20px}
  .container{max-width:1100px;margin:auto}
  .nav{display:flex;gap:10px;margin-bottom:20px}
  .tab{padding:10px 15px;border:1px solid #ddd;background:#fff;cursor:pointer;border-radius:8px}
  .tab.active{background:#111;color:#fff}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
  .card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:12px}
  .msg{padding:10px;border-radius:8px;border:1px solid #ffe08a;background:#fff8db;color:#8a5b00}
  .footer{text-align:center;font-size:12px;color:#555;margin-top:20px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
  <div class="nav">
    <button class="tab active" id="tabCatalog" onclick="go('catalog')">Catalogue</button>
    <button class="tab" id="tabCart" onclick="go('cart')">Panier</button>
  </div>

  <section id="pageCatalog">
    <div class="card">
      <div class="row">
        <input type="file" id="file" accept=".xlsx,.xls,.csv"/>
        <span id="status" class="msg" style="display:none"></span>
      </div>
    </div>
    <div id="grid" class="grid"></div>
  </section>

  <section id="pageCart" style="display:none">
    <h2>Panier</h2>
    <div id="cart"></div>
  </section>

  <div class="footer">UTILE ENTRAIGUES — Application de commande Fruits & Légumes</div>
</div>

<script>
let rows=[],cart=[];

function go(page){
 document.getElementById("pageCatalog").style.display= page==="catalog"?"":"none";
 document.getElementById("pageCart").style.display= page==="cart"?"":"none";
 document.getElementById("tabCatalog").classList.toggle("active",page==="catalog");
 document.getElementById("tabCart").classList.toggle("active",page==="cart");
 drawCart();
}

function showMsg(txt){ const s=document.getElementById("status"); s.textContent=txt; s.style.display='inline-block'; }
function hideMsg(){ const s=document.getElementById("status"); s.style.display='none'; }

function norm(s){ return String(s||"").trim().toLowerCase(); }

function findHeaderRow(matrix){
  // Cherche sur les 10 premières lignes une ligne contenant au moins 2 des clés
  const KEYS = ["famille","famille produit","désignation","designation","produit","libellé","libelle","prix"];
  const maxScan = Math.min(10, matrix.length);
  for(let r=0; r<maxScan; r++){
    const row = matrix[r]||[];
    const lower = row.map(norm);
    let hits = 0;
    for(const k of KEYS){
      if(lower.some(c => c.includes(k))) hits++;
    }
    if(hits >= 2){ return r; } // jugé ligne d'en-tête
  }
  return 0; // fallback première ligne
}

function headerMap(h){
  const s = norm(h);
  if(s.includes("famille")) return "famille";
  if(s.includes("désignation") || s.includes("designation") || s.includes("produit") || s.includes("libell")) return "designation";
  if(s.includes("prix")) return "prix";
  return null;
}

function parseMatrix(matrix){
  if(!matrix.length){ rows=[]; return; }
  const headerRow = findHeaderRow(matrix);
  const headers = (matrix[headerRow]||[]).map(h=>h==null?"":String(h));
  const keys = headers.map(headerMap);
  const idxFam = keys.indexOf("famille");
  const idxDes = keys.indexOf("designation");
  const idxPrix = keys.indexOf("prix");

  const out = [];
  for(let r = headerRow+1; r < matrix.length; r++){
    const row = matrix[r]||[];
    const fam = row[idxFam] != null ? String(row[idxFam]) : "";
    const des = row[idxDes] != null ? String(row[idxDes]) : "";
    const prix = idxPrix>=0 && row[idxPrix]!=null ? String(row[idxPrix]) : "";
    if(des.trim()==="") continue;
    out.push({id:String(r), famille:fam, designation:des, prix:prix});
  }
  rows = out;
}

function handleCSV(text){
  const lines = text.split(/\r?\n/);
  const sep = (lines[0] && lines[0].split(";").length>1) ? ";" : ",";
  const matrix = lines.map(l => l.split(sep));
  parseMatrix(matrix);
}

function handleXLSX(arrayBuffer){
  const wb = XLSX.read(new Uint8Array(arrayBuffer), {type:"array"});
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];
  const matrix = XLSX.utils.sheet_to_json(ws, {header:1, raw:true});
  parseMatrix(matrix);
}

function onFile(e){
  hideMsg();
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const ext = (f.name.split(".").pop()||"").toLowerCase();
  const reader = new FileReader();
  reader.onerror = () => showMsg("Lecture du fichier impossible. Essaie un autre navigateur ou réenregistre le fichier.");
  if(ext==="csv"){
    reader.onload = ev => { handleCSV(ev.target.result); afterImport(); };
    reader.readAsText(f, "utf-8");
  } else {
    reader.onload = ev => { handleXLSX(ev.target.result); afterImport(); };
    reader.readAsArrayBuffer(f);
  }
}

function afterImport(){
  if(!rows.length){
    showMsg("Aucun produit détecté. Vérifie que la première ou deuxième ligne contient bien des en-têtes (ex: 'Famille produit', 'Désignation complète', 'Prix').");
  } else {
    hideMsg();
  }
  draw();
}

document.getElementById("file").addEventListener("change", onFile);

function draw(){
 const g=document.getElementById("grid");
 if(!rows.length){
   g.innerHTML='<div class="msg">Importe un fichier Excel/CSV avec en-têtes : <b>Famille produit</b>, <b>Désignation complète</b>, <b>Prix</b>.</div>';
   return;
 }
 g.innerHTML=rows.map(r=>`<div class="card"><b>${r.famille||"&nbsp;"}</b><br>${r.designation}<br><small>${r.prix||""}</small><br>
 <input type='number' id='q_${r.id}' placeholder='Qté'>
 <select id='u_${r.id}'>
   <option>colis</option>
   <option>kilo</option>
   <option>pièce</option>
 </select>
 <button onclick='add("${r.id}")'>Ajouter</button></div>`).join("");
}

function add(id){
 const q=Number(document.getElementById("q_"+id).value);
 const u=document.getElementById("u_"+id).value;
 if(!q) return;
 const r=rows.find(x=>x.id===id);
 cart.push({...r, quantite:q, unite:u});
 drawCart();
}

function drawCart(){
 const c=document.getElementById("cart");
 if(!c) return;
 if(!cart.length){ c.innerHTML='<div class="msg">Panier vide</div>'; return; }
 c.innerHTML=cart.map(it=>`<div>${it.famille} - ${it.designation} : ${it.quantite} ${it.unite}</div>`).join("");
}
</script>
</body>
</html>